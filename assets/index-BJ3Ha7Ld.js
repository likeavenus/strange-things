var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{p as i,P as s}from"./phaser-Dp_CM4nq.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class a extends i.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.add.text(this.game.canvas.width/2,this.game.canvas.height/2,"Start"),this.input.once("pointerdown",(()=>{this.cameras.main.fadeOut(800),this.time.delayedCall(800,(()=>{this.scene.start("Home")}))}))}}var r=(e=>(e[e.Disabled=0]="Disabled",e[e.Ground=1]="Ground",e[e.Player=2]="Player",e[e.Projectile=4]="Projectile",e[e.EnergySphere=8]="EnergySphere",e[e.Enemy=16]="Enemy",e[e.Platforms=32]="Platforms",e[e.Torch=64]="Torch",e[e.EnemySphere=128]="EnemySphere",e[e.DeathCollider=256]="DeathCollider",e[e.Mimic=512]="Mimic",e[e.Treasure=1024]="Treasure",e[e.MimicAttack=2048]="MimicAttack",e[e.Portal=4096]="Portal",e))(r||{});const n=[{x:600,y:1500,text:"Я падал в пустоте долгое время, уже и не помню сколько времени прошло..."},{x:900,y:1500,text:"Что это за место? Напоминает мой замок, но здесь так пусто... я не был дома много лет"},{x:2e3,y:800,text:"Похоже на портал, но что он тут делает?"}],o=[{x:300,y:3010,text:"1"},{x:600,y:3010,text:"2"},{x:900,y:3010,text:"3"},{x:2e3,y:3010,text:"4"}];class h extends s.Physics.Matter.Sprite{constructor(e,i,s,a,n){super(e.matter.world,i,s,a),t(this,"direction"),t(this,"speed",0),t(this,"scene"),this.scene=e,this.direction=n,this.setCircle(this.width/4),this.setIgnoreGravity(!0),this.setFixedRotation(),this.setTint(61695).setDepth(150),this.setCollisionCategory(r.EnergySphere),this.setCollidesWith([r.Enemy,r.Ground,r.Mimic]),e.add.existing(this),this.launch(),this.scene.matter.world.on("collisionstart",this.handleCollision,this)}launch(){const e=this.scene.lights.addLight(this.x,this.y,256,void 0,5);e.color.set(0,.5,1);const t=this.scene.lights;this.scene.tweens.add({targets:this,speed:40,duration:40/70*1e3,onUpdate:(t,i)=>{if(i&&i.active){const t=i.speed*i.direction;i.setVelocityX(t),e.setPosition(i.x,i.y)}},onComplete:()=>{t.removeLight(e)}})}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.EnergySphere&&i.collisionFilter.category===r.Ground||i.collisionFilter.category===r.EnergySphere&&t.collisionFilter.category===r.Ground||t.collisionFilter.category===r.EnergySphere&&i.collisionFilter.category===r.Enemy||t.collisionFilter.category===r.Enemy&&i.collisionFilter.category===r.EnergySphere||t.collisionFilter.category===r.EnergySphere&&i.collisionFilter.category===r.Mimic||t.collisionFilter.category===r.Mimic&&i.collisionFilter.category===r.EnergySphere)&&this.destroy(!0)}))}update(){}}class l extends s.Physics.Matter.Sprite{constructor(e,i,s,a,n){var o;super(e.matter.world,i,s,a,n,{label:"wizard",frictionAir:.05}),t(this,"isTouchingGround",!1),t(this,"isAttacking",!1),t(this,"isFalling",!1),t(this,"isStunned",!1),t(this,"isCutscene",!1),t(this,"isTeleported",!1),t(this,"isReading",!1),t(this,"eKeyText"),t(this,"isRunning",!1),t(this,"jumpMaxCounter",2),t(this,"currentJumpCounter",0),t(this,"hp",10),t(this,"maxHP",10),t(this,"mana",4),t(this,"maxMana",6),t(this,"graphics"),t(this,"amuletOfLight"),t(this,"lightSphere"),t(this,"knockbackVelocity",15),t(this,"knockbackDuration",300),t(this,"knockbackTimer",0),t(this,"footstepTimer"),t(this,"footstepInterval",300),this.setName("wizard"),this.flipX=!1,(o=e.anims).create({key:"wizard_idle",frames:o.generateFrameNames("wizard_idle",{start:0,end:5,prefix:"Idle",suffix:".png"}),repeat:-1,frameRate:10}),o.create({key:"wizard_run",frames:o.generateFrameNames("wizard_run",{start:0,end:7,prefix:"Run",suffix:".png"}),repeat:-1,frameRate:14}),o.create({key:"wizard_jump",frames:o.generateFrameNames("wizard_jump",{start:0,end:1,prefix:"Jump",suffix:".png"}),repeat:-1,frameRate:10}),o.create({key:"wizard_fall",frames:o.generateFrameNames("wizard_fall",{start:0,end:1,prefix:"Fall",suffix:".png"}),repeat:-1,frameRate:10}),o.create({key:"wizard_attack1",frames:o.generateFrameNames("wizard_attack1",{start:10,end:17,prefix:"Attack",suffix:".png"}),frameRate:15}),o.create({key:"wizard_attack2",frames:o.generateFrameNames("wizard_attack2",{start:20,end:27,prefix:"Attack",suffix:".png"}),frameRate:15}),o.create({key:"wizard_death",frames:o.generateFrameNames("wizard_death",{start:0,end:6,prefix:"Death",suffix:".png"}),frameRate:11}),o.create({key:"wizard_hit",frames:o.generateFrameNames("wizard_hit",{start:0,end:3,prefix:"Hit",suffix:".png"}),frameRate:11}),this.anims.play("wizard_idle"),this.setScale(2).setDepth(150),this.setFixedRotation(),e.input.keyboard.on("keydown-Q",this.baseAttack,this),e.input.keyboard.on("keydown-F",this.rangeAttack,this),e.input.keyboard.on("keydown",this.toggleScrollPaper,this),this.setCollisionCategory(r.Player),this.setCollidesWith([r.Ground,r.Enemy,r.EnemySphere,r.MimicAttack,r.Portal]),e.add.existing(this),this.setPipeline("Light2D"),e.matter.world.on("collisionstart",this.handleCollision,this),e.matter.world.on("collisionstart",this.handleCollisionStart,this),e.matter.world.on("collisionend",this.handleCollisionEnd,this),this.graphics=e.add.graphics(),this.graphics.setDepth(150),e.time.addEvent({loop:!0,delay:1e3,callback:()=>{this.mana<6&&(this.mana+=.5)}}),this.createMagicLight(),this.eKeyText=this.scene.add.text(this.x+20,this.y-70,"press E"),this.eKeyText.setVisible(!1).setDepth(160)}baseAttack(){this.isAttacking||!this.isTouchingGround||this.hp<=0||(this.setVelocity(0),this.isAttacking=!0,this.setOrigin(.5,.7),this.anims.play("wizard_attack1"),this.once("animationcomplete",(e=>{"wizard_attack1"===e.key&&(this.isAttacking=!1,this.setOrigin(.5,.5),this.anims.play("wizard_idle",!0))})))}increaseFallSpeed(){this.setVelocityY(this.body.velocity.y+.5)}rangeAttack(){!this.isAttacking&&this.isTouchingGround&&(this.hp<=0||0===this.mana||(this.isAttacking=!0,this.scene.sound.play("energy-attack"),this.mana-=1,this.setOrigin(.4,.6),this.setVelocity(0),this.anims.play("wizard_attack2",!0),this.once("animationcomplete",(e=>{"wizard_attack2"===e.key&&(this.isAttacking=!1,this.setOrigin(.5,.5),this.anims.play("wizard_idle",!0))})),this.createEnergySphere()))}createEnergySphere(){const e=this.flipX?-1:1,t=new h(this.scene,e>0?this.x+60:this.x-60,this.y-this.height/2+15,"red",e);this.scene.projectiles.add(t)}playFootstep(){this.scene.sound.play("footstep",{volume:1})}handleFootsteps(){this.isRunning&&!this.footstepTimer?this.footstepTimer=this.scene.time.addEvent({delay:this.footstepInterval,callback:this.playFootstep,callbackScope:this,loop:!0}):!this.isRunning&&this.footstepTimer&&(this.footstepTimer.remove(),this.footstepTimer=null)}preUpdate(e,t){super.preUpdate(e,t)}update(e,t){var i;if(this.drawMana(),this.drawHP(),this.handleFootsteps(),this.amuletOfLight&&this.updateMagicLight(t),this.isReading)return;if(this.isTeleported)return;if(this.hp<=0)return;if(this.isStunned)return;this.isTouchingGround&&(null==(i=this.body)?void 0:i.velocity.x)<=0&&(this.isRunning=!1);const{left:a,right:r,up:n,down:o,space:h}=e;this.body.velocity.y>.1?this.isFalling=!0:this.isFalling=!1,this.isFalling&&this.increaseFallSpeed(),this.isAttacking||(!this.isTouchingGround&&this.body.velocity.y<0?(this.anims.play("wizard_jump",!0),r.isDown?(this.isRunning=!1,this.setVelocityX(12),this.flipX=!1):a.isDown&&(this.isRunning=!1,this.setVelocityX(-12),this.flipX=!0)):!this.isTouchingGround&&this.body.velocity.y>0?(r.isDown?(this.setVelocityX(12),this.flipX=!1):a.isDown&&(this.setVelocityX(-12),this.flipX=!0),this.isFalling&&this.anims.play("wizard_fall",!0)):a.isDown?(this.isRunning=!0,this.setVelocityX(-12),this.flipX=!0,this.anims.play("wizard_run",!0)):r.isDown?(this.isRunning=!0,this.setVelocityX(12),this.flipX=!1,this.anims.play("wizard_run",!0)):(this.setVelocityX(0),this.anims.play("wizard_idle",!0)),s.Input.Keyboard.JustDown(h)&&(this.isTouchingGround||!this.isTouchingGround&&this.currentJumpCounter<this.jumpMaxCounter)&&(this.setVelocityY(-30),this.isTouchingGround=!1,this.currentJumpCounter++),this.currentJumpCounter===this.jumpMaxCounter&&this.isTouchingGround&&(this.currentJumpCounter=0))}createMagicLight(){this.amuletOfLight=this.scene.lights.addLight(this.x,this.y,256,16777215,2),this.lightSphere=this.scene.matter.add.image(this.x,this.y,"red",void 0,{isStatic:!0,isSensor:!0,collisionFilter:{category:r.Disabled}}).setDepth(150)}updateMagicLight(e){this.amuletOfLight&&(this.amuletOfLight.setPosition(this.lightSphere.x,this.lightSphere.y),this.lightSphere.setPosition(this.x+(this.flipX?-70:70),this.y-70))}toggleScrollPaper(e){if("Escape"===e.code||"KeyE"===e.code){const e=this.scene.children.getByName("scroll");e.visible?(e.hideScroll(),this.isReading=!1):this.eKeyText.visible&&(e.showScroll(),this.isReading=!0)}}slowDownTime(){this.scene.matter.world.engine.timing.timeScale=.1,this.scene.time.delayedCall(300,(()=>{this.scene.matter.world.engine.timing.timeScale=1}))}getDamage(){this.isAttacking=!1,this.hp-=1,this.scene.sound.play("skull-crash"),this.applyKnockback(this.flipX?"left":"right"),this.isStunned=!0,this.scene.time.delayedCall(500,(()=>{this.isStunned=!1})),this.on("animationcomplete",(e=>{"wizard_hit"===e.key&&(this.isStunned=!1)})),this.hp<=0?(this.anims.play("wizard_death",!0),this.setOrigin(.5,.6),this.setCollisionCategory(r.DeathCollider)):(this.anims.play("wizard_hit"),this.scene.children.each((e=>{(null==e?void 0:e.anims)&&(e.anims.timeScale=.4)})),this.scene.time.delayedCall(300,(()=>{this.scene.children.each((e=>{(null==e?void 0:e.anims)&&(e.anims.timeScale=1)}))})))}applyKnockback(e){if(this.isStunned)return;const t="left"===e?this.knockbackVelocity:-this.knockbackVelocity;this.knockbackVelocity,this.setVelocityX(t),this.knockbackTimer=this.knockbackDuration}handleCollisionStart(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.Player&&i.collisionFilter.category===r.Ground||i.collisionFilter.category===r.Player&&t.collisionFilter.category===r.Ground)&&(this.isTouchingGround||(this.isTouchingGround=!0,this.currentJumpCounter=0))}))}handleCollisionEnd(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;t.collisionFilter.category===r.Ground&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.Ground&&(t.collisionFilter.category,r.Player)}))}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.EnemySphere&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.EnemySphere&&t.collisionFilter.category===r.Player||t.collisionFilter.category===r.MimicAttack&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.MimicAttack&&t.collisionFilter.category===r.Player||t.collisionFilter.category===r.Enemy&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.Enemy&&t.collisionFilter.category===r.Player)&&(this.scene.cameras.main.shake(500,.009),this.slowDownTime(),this.getDamage())}))}drawMana(){this.graphics.clear(),this.graphics.setScrollFactor(0),this.graphics.setPosition(50,50);const e=10;for(let t=0;t<this.mana;t++){const i=10+30*t,s=50;this.graphics.beginPath(),this.graphics.moveTo(i,s-e),this.graphics.lineTo(i+e,s),this.graphics.lineTo(i,s+e),this.graphics.lineTo(i-e,s),this.graphics.closePath(),this.graphics.fillPath(),t<this.mana&&(this.graphics.fillStyle(1118719),this.graphics.beginPath(),this.graphics.moveTo(i,s-e),this.graphics.lineTo(i+e,s),this.graphics.lineTo(i,s+e),this.graphics.lineTo(i-e,s),this.graphics.closePath(),this.graphics.fillPath())}}drawHP(){this.graphics.setScrollFactor(0),this.graphics.setPosition(10,30);for(let e=0;e<this.maxHP;e++){const t=10+25*e*1.3,i=10;this.graphics.fillStyle(16777215),this.graphics.fillCircle(t,i,13),e<this.hp&&(this.graphics.fillStyle(16711680),this.graphics.fillCircle(t,i,12))}}}class c extends h{constructor(e,i,s,a,n){super(e,i,s,a,n),t(this,"direction",-1),this.direction=n,this.setTint(4915330).setDepth(150),this.setCollisionCategory(r.EnemySphere),this.setCollidesWith([r.Player,r.Ground])}launch(){const e=this.scene.lights.addLight(this.x,this.y,256,void 0,5);e.color.set(.5,.1,0);const t=this.scene.lights;this.scene.tweens.add({targets:this,speed:40,duration:40/70*1e3,onUpdate:(t,i)=>{if(i&&i.active){const t=i.speed*i.direction;i.setVelocityX(t),e.setPosition(i.x,i.y)}},onComplete:()=>{t.removeLight(e)}})}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.EnemySphere&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.EnemySphere&&t.collisionFilter.category===r.Player||t.collisionFilter.category===r.EnemySphere&&i.collisionFilter.category===r.Ground||i.collisionFilter.category===r.EnemySphere&&t.collisionFilter.category===r.Ground)&&this.destroy(!0)}))}}class d extends s.Physics.Matter.Sprite{constructor(e,i,a,n,o){var h;super(e.matter.world,i,a,n,o,{label:"heretic",frictionAir:.05}),t(this,"hp",100),t(this,"isTouchingGround",!1),t(this,"isAttacking",!1),t(this,"isStunned",!1),t(this,"isFalling",!1),t(this,"jumpMaxCounter",2),t(this,"currentJumpCounter",0),t(this,"direction",1),t(this,"isDead",!1),this.flipX=!1,(h=e.anims).create({key:"heretic_run",frames:h.generateFrameNames("heretic_run",{start:0,end:7,prefix:"Run",suffix:".png"}),repeat:-1,frameRate:10}),h.create({key:"heretic_death",frames:h.generateFrameNames("heretic_death",{start:0,end:6,prefix:"Death",suffix:".png"}),repeat:0,frameRate:10}),h.create({key:"heretic_idle",frames:h.generateFrameNames("heretic_idle",{start:0,end:7,prefix:"Idle",suffix:".png"}),repeat:0,frameRate:10}),h.create({key:"heretic_hit",frames:h.generateFrameNames("heretic_hit",{start:0,end:2,prefix:"hit",suffix:".png"}),repeat:0,frameRate:5}),h.create({key:"heretic_attack2",frames:h.generateFrameNames("heretic_attack2",{start:20,end:27,prefix:"Attack",suffix:".png"}),frameRate:15}),this.anims.play("heretic_run"),this.setScale(3),this.setRectangle(2*this.width,3*this.height,{}),this.setFixedRotation(),this.setOnCollide((e=>{this.isTouchingGround=!0})),this.setCollisionCategory(r.Enemy),this.setCollidesWith([r.Ground,r.Player,r.EnergySphere]),e.add.existing(this),this.scene.matter.world.on("collisionstart",this.handleCollision,this),this.scene.time.addEvent({loop:!0,delay:1600,callback:()=>{this.isDead||this.isStunned||this.isAttacking||this.scene.children.getByName("wizard").hp<=0||(this.direction=-this.direction)}}),this.scene.time.addEvent({loop:!0,delay:2e3,callback:()=>{if(this.isDead)return;if(this.isStunned)return;if(this.isAttacking)return;const e=this.scene.children.getByName("wizard");e.hp<=0||s.Math.Distance.Between(e.x,e.y,this.x,this.y)<600&&(e.x>this.x?this.direction=-1:this.direction=1,this.rangeAttack())}})}increaseFallSpeed(){this.setVelocityY(this.body.velocity.y+.5)}rangeAttack(){!this.isAttacking&&this.isTouchingGround&&(this.isAttacking=!0,this.setOrigin(.4,.68),this.setVelocity(0),this.anims.play("heretic_attack2",!0),this.once("animationcomplete",(e=>{"heretic_attack2"===e.key&&(this.isAttacking=!1,this.setOrigin(.5,.5),this.anims.play("heretic_run",!0))})),this.createEnergySphere())}createEnergySphere(){const e=this.flipX?-1:1,t=new c(this.scene,e>0?this.x+30:this.x-30,this.y-this.height/2+15,"red",e);this.scene.projectiles.add(t)}update(e){if(!this.isStunned&&!this.isAttacking&&!(this.isDead||this.hp<=0))return this.scene.children.getByName("wizard").hp<=0?(this.anims.play("heretic_idle",!0),void this.setOrigin(.5,.68)):void(this&&(this.direction>0?(this.flipX=!1,this.setVelocityX(10)):(this.flipX=!0,this.setVelocityX(-10))))}getDamage(){this.isAttacking=!1,this.hp-=10,this.scene.sound.play("skull-crash"),this.isStunned=!0,this.on("animationcomplete",(e=>{"heretic_hit"!==e.key||this.isDead||(this.isStunned=!1,this.anims.play("heretic_run"),this.setOrigin(.5,.8))})),this.hp<=0?(this.isDead=!0,this.anims.play("heretic_death",!0),this.setCollisionCategory(r.DeathCollider),this.setOrigin(.5,.725)):(this.anims.play("heretic_hit"),this.setOrigin(.5,.6)),this.isDead||this.scene.time.delayedCall(500,(()=>{this.anims.play("heretic_run"),this.setOrigin(.5,.5),this.isStunned=!1}))}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.EnergySphere&&i.collisionFilter.category===r.Enemy||i.collisionFilter.category===r.EnergySphere&&t.collisionFilter.category===r.Enemy)&&this.getDamage()}))}}class p extends s.Physics.Matter.Sprite{constructor(e,i,s,a,n){var o;super(e.matter.world,i,s,a,n,{label:"mimic",frictionAir:.05}),t(this,"isTouchingGround",!1),t(this,"isOpen",!1),t(this,"isAttacking",!1),this.setName("mimic"),this.flipX=!0,(o=e.anims).create({key:"mimic_hidden",frames:[{key:"mimic_hidden",frame:"Mimic_Idle_Hidden0.png",duration:1500},{key:"mimic_hidden",frame:"Mimic_Idle_Hidden1.png",duration:200},{key:"mimic_hidden",frame:"Mimic_Idle_Hidden2.png",duration:1500},{key:"mimic_hidden",frame:"Mimic_Idle_Hidden3.png",duration:200}],repeat:-1,frameRate:10,duration:3e3}),o.create({key:"mimic_open",frames:o.generateFrameNames("mimic_open",{start:0,end:3,prefix:"Chest",suffix:".png"}),frameRate:10,duration:1e3}),o.create({key:"mimic_attack1",frames:o.generateFrameNames("mimic_attack1",{start:10,end:13,prefix:"Mimic_Attack-",suffix:".png"}),frameRate:9,duration:1e3}),this.anims.play("mimic_hidden"),this.anims.pause(),this.setScale(4),this.setDepth(99),this.setFixedRotation(),this.setCollisionCategory(r.Mimic),this.setCollidesWith([r.Ground,r.Enemy,r.EnemySphere,r.EnergySphere]),e.add.existing(this),this.setPipeline("Light2D"),e.matter.world.on("collisionstart",this.handleCollision,this)}baseAttack(){if(this.isAttacking||this.isOpen)return;let e;this.isAttacking=!0,this.setOrigin(.5,.59),this.anims.play("mimic_attack1"),this.scene.time.delayedCall(250,(()=>{this.scene.sound.setDetune(2e3*Math.random()),this.scene.sound.stopByKey("mimic-attack1"),this.scene.sound.play("mimic-attack1"),e=this.scene.matter.add.rectangle(this.x-50,this.y,100,100,{isSensor:!0,isStatic:!0,collisionFilter:{category:r.MimicAttack,mask:r.Player}})})),this.once("animationcomplete",(t=>{"mimic_attack1"===t.key&&(e&&this.scene.matter.world.remove(e),this.isAttacking=!1,this.setOrigin(.5,.5),this.anims.play("mimic_hidden",!0))}))}update(e){if(this.isAttacking||this.isOpen)return;const t=this.scene.children.getByName("wizard");s.Math.Distance.Between(t.x,t.y,this.x,this.y)<500?this.anims.play("mimic_hidden",!0):(this.anims.play("mimic_hidden",!0),this.anims.pause()),s.Math.Distance.Between(t.x,t.y,this.x,this.y)<200&&t.hp>0&&this.baseAttack()}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;(t.collisionFilter.category===r.EnergySphere&&i.collisionFilter.category===r.Mimic||i.collisionFilter.category===r.EnergySphere&&t.collisionFilter.category===r.Mimic)&&(this.isOpen||(this.anims.play("mimic_open",!0),this.isOpen=!0))}))}}class m extends s.Renderer.WebGL.Pipelines.PostFXPipeline{constructor(e){super({game:e,name:"CRTShader",fragShader:"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nuniform sampler2D uMainSampler;\nuniform float time;\nuniform vec2 resolution;\n\nvoid main(void) {\n    vec2 uv = gl_FragCoord.xy / resolution.xy;\n\n    // Цветовые каналы с небольшими искажениями\n    float r = texture2D(uMainSampler, uv + sin(uv.y * 10.0 + time * 5.0) * 0.002).r;\n    float g = texture2D(uMainSampler, uv + sin(uv.y * 10.0 + time * 5.0 + 2.0) * 0.002).g;\n    float b = texture2D(uMainSampler, uv + sin(uv.y * 10.0 + time * 5.0 + 4.0) * 0.002).b;\n\n    // Добавляем сканирующие линии\n    float scanline = sin(uv.y * resolution.y * 3.1415) * 0.02;\n    vec3 color = vec3(r, g, b) - scanline;\n\n    gl_FragColor = vec4(color, 1.0);\n}\n"})}onPreRender(){this.set1f("time",this.game.loop.time/2e3),this.set2f("resolution",this.renderer.width,this.renderer.height)}}class g extends Phaser.GameObjects.NineSlice{constructor(e,t,i,s,a,r,n,o,h,l,c){super(e,t,i,s,a,r,n,o,h,l,c),this.setScrollFactor(0,0),this.setDepth(200),this.visible=!1,this.setName("scroll"),e.add.existing(this)}showScroll(){this.setVisible(!0),this.scene.sound.play("scroll-sound",{volume:1})}hideScroll(){this.setVisible(!1)}}class u extends s.Renderer.WebGL.Pipelines.PostFXPipeline{constructor(e,i=0){super({game:e,name:"VortexPostFX",fragShader:"\n        precision mediump float;\n        uniform float time;\n        uniform sampler2D uMainSampler;\n        varying vec2 outTexCoord;\n\n        void main(void) {\n          vec2 uv = outTexCoord;\n          vec2 tc = uv - 0.5;\n          float dist = length(tc);\n          float angle = atan(tc.y, tc.x);\n          float speed = -1.0;\n          angle += dist * speed * time;\n          tc = dist * vec2(cos(angle), sin(angle));\n          uv = tc + 0.5;\n          vec4 color = texture2D(uMainSampler, uv);\n          gl_FragColor = color;\n        }\n      "}),t(this,"_time",0),t(this,"_timeDirection",1),this._time=i}setTimeDirection(e){this._timeDirection=e}onPreRender(){const e=.01*this.game.loop.delta;this._timeDirection>0?this._time+=this._timeDirection*e:this._time-=this._timeDirection*e,this.set1f("time",this._time)}}class y extends i.Scene{constructor(){super("Game"),t(this,"camera"),t(this,"wizard"),t(this,"paper"),t(this,"currentText",""),t(this,"paperTextObject"),t(this,"papersGroup"),t(this,"cursors"),t(this,"projectiles"),t(this,"light"),t(this,"heretic"),t(this,"hereticGroup"),t(this,"isCutscene",!1),t(this,"mimic"),t(this,"currentMusic"),t(this,"randomSound"),t(this,"topBlackBars"),t(this,"bottomBlackBars")}preload(){this.cursors=this.input.keyboard.createCursorKeys()}initMusic(){this.currentMusic=this.sound.add("mysterious-dungeons-ambiance",{volume:.5}),this.randomSound=this.sound.add("creepy-demon-heavy-breathing",{volume:.7}),this.time.addEvent({loop:!0,delay:2e4,callback:()=>{this.randomSound.play()}}),this.currentMusic.play()}createPlatform(e,t,i){const s=this.matter.add.image(e,t,"platform",void 0,{isStatic:!0,label:"platform"});s.setPipeline("Light2D"),i?this.tweens.add({targets:s,y:s.y-1e3,yoyo:!0,duration:4e3,repeat:-1,ease:"ease"}):this.tweens.add({targets:s,y:s.x-1e3,yoyo:!0,duration:4e3,repeat:-1,ease:"ease"})}createMap(){const e=this.make.tilemap({key:"map",tileHeight:64,tileWidth:64}),t=e.addTilesetImage("brick","tileset",64,64);[e.createLayer("ground",t,0,0),e.createLayer("platforms",t,0,0),e.createLayer("handle1",t,0,0)].forEach((e=>{const t=null==e?void 0:e.layer.name;null==e||e.setName(t),null==e||e.setCollisionByProperty({collides:!0}),"ground"===t&&(null==e||e.setCollisionCategory(r.Ground)),"platforms"===t&&(null==e||e.setCollisionCategory(r.Platforms)),null==e||e.setCollidesWith([r.Player,r.Projectile,r.Enemy]),null==e||e.setPipeline("Light2D"),this.matter.world.convertTilemapLayer(e)}))}createTorch(e,t){this.anims.create({key:"torch1",frames:this.anims.generateFrameNames("torch1",{start:10,end:12,prefix:"bigtorchlit",suffix:".png"}),repeat:-1,frameRate:9});const i=this.matter.add.sprite(e,t,"torch1",void 0,{isStatic:!0});i.setScale(1.5),i.setPipeline("Light2D"),i.anims.play("torch1"),this.lights.addLight(i.x,i.y-100,512,void 0,2),i.setCollisionCategory(r.Torch)}toggleTextInPaper(e){"Escape"!==e.code&&"KeyE"!==e.code||(this.paperTextObject.setText(this.currentText),this.paperTextObject.setVisible(!this.paperTextObject.visible))}initPortalEffect(){const e=new u(this.game,4);this.cameras.main.setPostPipeline(e),console.log("vortexPipeline: ",e),e.setTimeDirection(-1)}create(){var e;this.initMusic(),this.createPaperScroll(),this.createInfoPapers(),null==(e=this.input.keyboard)||e.on("keydown",this.toggleTextInPaper,this),this.camera=this.cameras.main,this.camera.setZoom(.9),this.camera.fadeIn(1e3),this.camera.setPostPipeline(new m(this.game)),this.lights.enable(),this.projectiles=this.add.group(),this.createPlatform(1290,2800,!0),this.createTorch(150,2975),this.createTorch(1050,2975),this.createTorch(2350,3100),this.createTorch(1e3,1060),this.createTorch(3700,2850),this.wizard=new l(this,90,2975,"wizard_idle"),this.createMap(),this.camera.setDeadzone(250,250),this.camera.startFollow(this.wizard,!0,1,1,-100,-30),this.light=this.lights.addLight(this.wizard.x,this.wizard.y,512,void 0,1),this.hereticGroup=this.add.group({classType:d,key:"heretic",runChildUpdate:!0,createCallback(e){e.setPosition(1e3,2900)}}),this.mimic=new p(this,3600,2900,"mimic_hidden")}createBlackBars(){const e=this.cameras.main.width;this.topBlackBars=this.add.rectangle(e/2,-50,e,100,0).setOrigin(.5,0).setDepth(1e3),this.bottomBlackBars=this.add.rectangle(e/2,this.cameras.main.height+50,e,100,0).setOrigin(.5,1).setDepth(1e3),this.tweens.add({targets:this.topBlackBars,y:0,duration:1e3,ease:"Power2"}),this.tweens.add({targets:this.bottomBlackBars,y:this.cameras.main.height,duration:1e3,ease:"Power2"})}createPaperScroll(){this.paper=new g(this,this.game.canvas.width/2,this.game.canvas.height/2,"paper",void 0,600,700,32,32,32,32),this.paperTextObject=this.add.text(this.scene.scene.game.canvas.width/2-180,this.scene.scene.game.canvas.height/3.2,this.currentText,{fontFamily:"Georgia",fontSize:"20px",color:"#000000",wordWrap:{width:this.paper.width-205,useAdvancedWrap:!0},align:"left"}),this.paperTextObject.setScrollFactor(0).setVisible(!1),this.paperTextObject.setDepth(300)}createInfoPapers(){this.papersGroup=this.add.group();for(let e=0;e<o.length;e++){const t=this.matter.add.image(o[e].x,o[e].y,"info-paper",void 0,{isStatic:!0,isSensor:!0,label:"info-paper"});t.setData("paper-text",o[e].text),t.setName("info-paper").setScale(.03).setDepth(150),this.papersGroup.add(t)}}update(e,t){this.wizard.update(this.cursors,e),this.mimic.update(this.cursors),this.projectiles.children.each((function(e){e.update()}),this);let i=!1;this.papersGroup.getChildren().forEach((e=>{const t=e;Phaser.Math.Distance.Between(this.wizard.x,this.wizard.y,t.x,t.y)<100&&(this.wizard.eKeyText.setPosition(t.x,t.y-120).setVisible(!0),this.currentText=e.getData("paper-text"),i=!0)})),i||(this.wizard.eKeyText.setVisible(!1),this.currentText="")}}class f extends i.Scene{constructor(){super("Preloader")}init(){const e=this.add.rectangle(this.game.canvas.width/2,this.game.canvas.height/2,468,32).setStrokeStyle(1,16777215),t=this.add.rectangle(4+e.x-e.width/2,e.y,4,28,16777215);this.load.on("progress",(e=>{t.width=4+460*e}))}loadHeretic(){this.load.atlas("heretic_run","heretic/run/Run.png","heretic/run/Run.json"),this.load.atlas("heretic_attack2","heretic/attack2/Attack2.png","heretic/attack2/Attack2.json"),this.load.atlas("heretic_death","heretic/death/Death.png","heretic/death/Death.json"),this.load.atlas("heretic_idle","heretic/idle/Idle.png","heretic/idle/Idle.json"),this.load.atlas("heretic_hit","heretic/hit/hit.png","heretic/hit/hit.json")}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png"),this.load.atlas("wizard_idle","wizard/idle/idle.png","wizard/idle/idle.json"),this.load.atlas("wizard_run","wizard/run/Run.png","wizard/run/Run.json"),this.load.atlas("wizard_jump","wizard/jump/Jump.png","wizard/jump/Jump.json"),this.load.atlas("wizard_fall","wizard/fall/Fall.png","wizard/fall/Fall.json"),this.load.atlas("wizard_attack1","wizard/attack1/Attack1.png","wizard/attack1/Attack1.json"),this.load.atlas("wizard_attack2","wizard/attack2/Attack2.png","wizard/attack2/Attack2.json"),this.load.atlas("wizard_death","wizard/death/Death.png","wizard/death/Death.json"),this.load.atlas("wizard_hit","wizard/hit/Hit.png","wizard/hit/Hit.json"),this.load.image("tileset","map/brick.png"),this.load.tilemapTiledJSON("map","map/map.json"),this.load.image("home-tileset","map/home.png"),this.load.tilemapTiledJSON("home","map/home.json"),this.load.image("home-bg-1","map/home/home-bg-1.png"),this.load.atlas("portal","environment/portal/portal.png","environment/portal/portal.json"),this.load.image("platform","map/platform.png"),this.load.image("red","wizard/magic/red.png"),this.load.atlas("torch1","torch/torch.png","torch/torch.json"),this.loadHeretic(),this.load.audio("footstep","wizard/footstep.mp3"),this.load.audio("creepy-demon-heavy-breathing","environment/sounds/creepy-demon-heavy-breathing.wav"),this.load.audio("mysterious-dungeons-ambiance","environment/sounds/mysterious-dungeons-ambiance.mp3"),this.load.audio("dungeon","environment/sounds/dungeon_.mp3"),this.load.audio("skull-crash","wizard/skull-crash.mp3"),this.load.audio("mimic-attack1","mimic/mimic-attack1.mp3"),this.load.audio("energy-attack","wizard/energy-attack.mp3"),this.load.audio("scroll-sound","environment/sounds/scroll-sound.mp3"),this.load.audio("dark-ambient-bg","environment/sounds/dark-ambient-bg.mp3"),this.load.audio("monster-growl","environment/sounds/monster-growl.wav"),this.load.audio("teleport","environment/sounds/teleport.mp3"),this.load.atlas("mimic_hidden","mimic/Mimic_Idle_Hidden.png","mimic/Mimic_Idle_Hidden.json"),this.load.atlas("mimic_open","mimic/Mimic_Open.png","mimic/Mimic_Open.json"),this.load.atlas("mimic_attack1","mimic/Mimic_Attack-1.png","mimic/Mimic_Attack-1.json"),this.load.image("paper","environment/scroll/scroll.png"),this.load.image("info-paper","environment/scroll/info-paper.png")}create(){this.scene.start("Boot")}}class k extends s.Physics.Matter.Sprite{constructor(e,t,i,s,a){var n;super(e.matter.world,t,i,s,a,{label:"portal",isSensor:!0,isStatic:!0}),this.setName("portal"),(n=e.anims).create({key:"portal-animate",frames:n.generateFrameNames("portal",{start:0,end:104,prefix:"convert",suffix:".png"}),repeat:-1,frameRate:14}),this.anims.play("portal-animate"),this.setDepth(150),this.setFixedRotation(),this.setCollisionCategory(r.Portal),this.setCollidesWith([r.Player]),e.add.existing(this),this.setPipeline("Light2D"),this.scene.lights.addLight(this.x,this.y-20,256,255,2),e.matter.world.on("collisionstart",this.handleCollision,this)}update(e){}handleCollision(e){e.pairs.forEach((e=>{const{bodyA:t,bodyB:i}=e;if(t.collisionFilter.category===r.Portal&&i.collisionFilter.category===r.Player||i.collisionFilter.category===r.Portal&&t.collisionFilter.category===r.Player){const e=this.scene.children.getByName("wizard"),t=this.scene.cameras.main;t.setPostPipeline("VortexPostFX"),e.isTeleported=!0,e.anims.play("wizard_idle");const i=t.getPostPipeline("VortexPostFX");console.log("pipeline: ",i),i.setTimeDirection(1),this.scene.sound.play("teleport"),this.scene.time.delayedCall(4e3,(()=>{t.fadeOut(800,0,0,0),this.scene.time.delayedCall(1050,(()=>{this.scene.sound.stopAll(),this.scene.scene.start("Game")}))}))}}))}}class w extends s.Scene{constructor(){super("Home"),t(this,"wizard"),t(this,"portal"),t(this,"camera"),t(this,"cursors"),t(this,"paper"),t(this,"currentText",""),t(this,"paperTextObject"),t(this,"papersGroup"),t(this,"startNoiseActive",!0)}init(){this.cameras.main.fadeOut(0)}preload(){this.cursors=this.input.keyboard.createCursorKeys()}addBgMusic(){this.sound.play("dark-ambient-bg",{volume:1})}addBackground(){this.add.image(1240,1e3,"home-bg-1").setScale(5,4).setDepth(0)}createTorch(e,t){this.anims.create({key:"torch1",frames:this.anims.generateFrameNames("torch1",{start:10,end:12,prefix:"bigtorchlit",suffix:".png"}),repeat:-1,frameRate:9});const i=this.matter.add.sprite(e,t,"torch1",void 0,{isStatic:!0});i.setScale(1).setDepth(150),i.setPipeline("Light2D"),i.anims.play("torch1"),this.lights.addLight(i.x,i.y-50,512,void 0,2),i.setCollisionCategory(r.Torch)}createPaperScroll(){this.paper=new g(this,this.game.canvas.width/2,this.game.canvas.height/2,"paper",void 0,600,700,32,32,32,32),this.paperTextObject=this.add.text(this.scene.scene.game.canvas.width/2-180,this.scene.scene.game.canvas.height/3.2,this.currentText,{fontFamily:"Georgia",fontSize:"20px",color:"#000000",wordWrap:{width:this.paper.width-205,useAdvancedWrap:!0},align:"left"}),this.paperTextObject.setScrollFactor(0).setVisible(!1),this.paperTextObject.setDepth(300)}createInfoPapers(){this.papersGroup=this.add.group();for(let e=0;e<n.length;e++){const t=this.matter.add.image(n[e].x,n[e].y,"info-paper",void 0,{isStatic:!0,isSensor:!0,label:"info-paper"});t.setData("paper-text",n[e].text),t.setName("info-paper").setScale(.03).setDepth(150),this.papersGroup.add(t),this.matter.world.on("collisionstart",(e=>{e.pairs.forEach((e=>{var t=e.bodyA,i=e.bodyB,s=t.gameObject,a=i.gameObject;if(s===this.wizard&&this.papersGroup.contains(a)||a===this.wizard&&this.papersGroup.contains(s)){var r=this.papersGroup.contains(s)?s:a;r&&r.active}}))}),this)}}addStartNoise(){this.startNoiseActive&&(this.sound.play("monster-growl"),this.startNoiseActive=!1)}setupCamera(){this.camera=this.cameras.main,this.camera.fadeIn(1e3)}create(){var e;this.setupCamera(),this.wizard=new l(this,90,1400,"wizard_idle"),null==(e=this.input.keyboard)||e.on("keydown",this.toggleTextInPaper,this),this.createPaperScroll(),this.createMap(),this.createInfoPapers(),this.projectiles=this.add.group(),this.portal=new k(this,2400,700,"portal"),this.camera.setDeadzone(250,250),this.camera.startFollow(this.wizard,!0,1,1,-50,0),this.lights.enable(),this.createTorch(120,1300),this.createTorch(650,1300),this.createTorch(1300,1300),this.createTorch(2e3,1300)}toggleTextInPaper(e){"Escape"!==e.code&&"KeyE"!==e.code||(this.paperTextObject.setText(this.currentText),this.paperTextObject.setVisible(!this.paperTextObject.visible))}createMap(){const e=this.make.tilemap({key:"home",tileHeight:64,tileWidth:64}),t=e.addTilesetImage("home","home-tileset",64,64);[e.createLayer("ground",t,0,0),e.createLayer("objects",t,0,0)].forEach((e=>{const t=null==e?void 0:e.layer.name;null==e||e.setName(t),null==e||e.setDepth(100),null==e||e.setCollisionByProperty({collides:!0}),null==e||e.setCollidesWith([r.Player,r.Projectile,r.Enemy]),null==e||e.setPipeline("Light2D"),this.matter.world.convertTilemapLayer(e)}))}update(e,t){this.wizard.update(this.cursors,e);let i=!1;this.papersGroup.getChildren().forEach((e=>{const t=e;s.Math.Distance.Between(this.wizard.x,this.wizard.y,t.x,t.y)<100&&(this.wizard.eKeyText.setPosition(t.x,t.y-120).setVisible(!0),this.currentText=e.getData("paper-text"),i=!0)})),i||(this.wizard.eKeyText.setVisible(!1),this.currentText="")}}const x={type:Phaser.WEBGL,width:innerWidth,parent:"game-container",scale:{},physics:{default:"matter",matter:{gravity:{y:2}}},pipeline:{CRTShader:m,VortexPostFX:u},scene:[f,a,w,y]};new i.Game(x);
